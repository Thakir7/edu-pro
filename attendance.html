<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>سجل الحضور</title>
  <link rel="stylesheet" href="assets/style.css">

  <style>
    .cardX{background:#fff;border-radius:18px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .title{font-size:22px;font-weight:900;margin:0}
    .sub{opacity:.7;margin-top:6px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{padding:10px 14px;border-radius:14px;border:0;cursor:pointer;font-weight:800}
    .btn.ghost{background:#f2f4f7;color:#111}
    .pill{background:#f2f4f7;border-radius:999px;padding:6px 10px;font-weight:800;font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;overflow:hidden;border-radius:16px}
    th,td{padding:10px 10px;border-bottom:1px solid #eee;font-size:14px;text-align:center;white-space:nowrap}
    th{background:#fafbfc;font-weight:900}
    tbody tr:nth-child(even){background:#fcfcfd}
    .status{font-weight:900}
    .present{color:#0a7a3b}
    .absent{color:#b00020}
    .excused{color:#b36b00}
    .note{margin-top:10px;font-weight:800}
    .err{color:#b00020}
    .ok{color:#0a7a3b}
    .wrap{overflow:auto}

    .groupbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .groupbar .btn{min-width:120px}
    .btn.active{outline:2px solid #111}
  </style>
</head>

<body>
<div class="container">
  <div class="topbar">
    <div class="brand">سجل الحضور</div>
    <div class="actions">
      <button class="btn ghost" onclick="history.back()">رجوع</button>
    </div>
  </div>

  <div class="cardX">
    <div class="row">
      <div>
        <h1 class="title" id="who">...</h1>
        <div class="sub" id="meta">...</div>
      </div>
      <div class="pill" id="summary">...</div>
    </div>

    <div id="msg" class="note"></div>

    <div id="groupBar" class="groupbar" style="display:none"></div>

    <div class="wrap" id="tableWrap" style="display:none">
      <table id="attTable"></table>
    </div>
  </div>
</div>

<script>
const API_URL = "https://tvtc-exam-api.ensancom.workers.dev/";

function getSession(){ try{ return JSON.parse(localStorage.getItem("edu_session")||"null"); }catch(e){ return null; } }
function requireSession(){
  const s = getSession();
  if(!s || !s.traineeId){
    localStorage.removeItem("edu_session");
    location.replace("index.html");
    return null;
  }
  return s;
}
function showMsg(text, isErr){
  const el = document.getElementById("msg");
  el.textContent = text || "";
  el.className = "note " + (isErr ? "err" : "ok");
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
async function apiCall(payload){
  const controller = new AbortController();
  const timer = setTimeout(()=>controller.abort(), 12000);
  try{
    const r = await fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload||{}),
      signal: controller.signal
    });
    const text = await r.text();
    try{ return JSON.parse(text); }
    catch(e){ return { ok:false, message:"الخادم ردّ برد غير JSON", raw:text.slice(0,250) }; }
  }catch(e){
    if(String(e).includes("AbortError")) return { ok:false, message:"Timeout خلال 12 ثانية." };
    return { ok:false, message:"فشل الاتصال: " + String(e) };
  }finally{ clearTimeout(timer); }
}

function statusClass(v){
  if(v==="حاضر") return "present";
  if(v==="غائب") return "absent";
  if(v==="مستأذن") return "excused";
  return "";
}
function safeStatus(v){
  const s = String(v||"").trim();
  return s || "—";
}
function calcSummaryFromWeeks(weeks, twoSessions){
  let حاضر=0, غائب=0, مستأذن=0;
  for(let w=1; w<=16; w++){
    const l1 = String(weeks?.[w]?.l1 || "").trim();
    const l2 = twoSessions ? String(weeks?.[w]?.l2 || "").trim() : "";
    const arr = [l1,l2].filter(Boolean);
    for(const v of arr){
      if(v==="حاضر") حاضر++;
      else if(v==="غائب") غائب++;
      else if(v==="مستأذن") مستأذن++;
    }
  }
  return {حاضر,غائب,مستأذن};
}

async function ensureProfileAndGroups(s){
  // ✅ دائمًا نجرب getProfile لتحديث الاسم والشعب (بدون كسر القديم)
  const p = await apiCall({ action:"getProfile", traineeId: String(s.traineeId||"") });
  console.log("PROFILE_RES", p);

  if(p && p.ok && p.found){
    if(p.name) s.name = String(p.name).trim();
    const groups = Array.isArray(p.groups) ? p.groups : [];
    const pg = String(p.primaryGroup || groups[0] || "").trim();

    if(groups.length) s.groups = groups;
    if(pg) {
      s.primaryGroup = pg;
      s.group = pg; // توافق قديم
    }

    localStorage.setItem("edu_session", JSON.stringify(s));
    return s;
  }

  // fallback: لو session القديم فيه group
  const g = String(s.group||"").trim();
  if(g){
    s.groups = [g];
    s.primaryGroup = g;
    localStorage.setItem("edu_session", JSON.stringify(s));
  }
  return s;
}

async function fetchAttendance(traineeId, section){
  return await apiCall({
    action: "attendance",
    traineeId: String(traineeId),
    section: String(section)
  });
}

function renderGroupBar(groups, active, onPick){
  const bar = document.getElementById("groupBar");
  if(!Array.isArray(groups) || groups.length <= 1){
    bar.style.display = "none";
    bar.innerHTML = "";
    return;
  }
  bar.style.display = "flex";
  bar.innerHTML = "";
  groups.forEach(g=>{
    const b = document.createElement("button");
    b.className = "btn ghost" + (String(g)===String(active) ? " active" : "");
    b.textContent = "شعبة " + g;
    b.onclick = ()=> onPick(g);
    bar.appendChild(b);
  });
}

function renderSingleGroupTable(group, weeks){
  const table = document.getElementById("attTable");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="min-width:140px">الأسبوع</th>
        <th style="min-width:140px">شعبة ${escapeHtml(group)}</th>
      </tr>
    </thead>
    <tbody>
      ${
        Array.from({length:16},(_,i)=>{
          const w=i+1;
          const v=safeStatus(weeks?.[w]?.l1);
          const c=statusClass(v);
          return `<tr>
            <td>${escapeHtml("الأسبوع " + w)}</td>
            <td class="status ${c}">${escapeHtml(v)}</td>
          </tr>`;
        }).join("")
      }
    </tbody>
  `;
}

function renderTwoSessionsTable(weeks){
  const table = document.getElementById("attTable");
  table.innerHTML = `
    <thead>
      <tr>
        <th style="min-width:140px">الأسبوع</th>
        <th style="min-width:140px">اللقاء الأول</th>
        <th style="min-width:140px">اللقاء الثاني</th>
      </tr>
    </thead>
    <tbody>
      ${
        Array.from({length:16},(_,i)=>{
          const w=i+1;
          const v1=safeStatus(weeks?.[w]?.l1);
          const v2=safeStatus(weeks?.[w]?.l2);
          const c1=statusClass(v1), c2=statusClass(v2);
          return `<tr>
            <td>${escapeHtml("الأسبوع " + w)}</td>
            <td class="status ${c1}">${escapeHtml(v1)}</td>
            <td class="status ${c2}">${escapeHtml(v2)}</td>
          </tr>`;
        }).join("")
      }
    </tbody>
  `;
}

async function loadForGroup(s, group){
  if(!group){
    document.getElementById("summary").textContent = "—";
    document.getElementById("tableWrap").style.display = "none";
    showMsg("لا توجد شعبة لهذا المتدرب. تأكد من تعبئة F و G في شيت المتدربين.", true);
    return;
  }

  document.getElementById("summary").textContent = "جار التحميل...";
  showMsg("", false);
  document.getElementById("tableWrap").style.display = "none";

  const res = await fetchAttendance(s.traineeId, group);
  console.log("ATT_RES", group, res);

  if(!res || !res.ok){
    document.getElementById("summary").textContent = "—";
    showMsg((res && res.message) ? res.message : "تعذر جلب الحضور", true);
    return;
  }

  const isTwo = String(group) === "63107";
  const sum = calcSummaryFromWeeks(res.weeks, isTwo);
  document.getElementById("summary").textContent =
    `حاضر ${sum.حاضر} • غائب ${sum.غائب} • مستأذن ${sum.مستأذن}`;

  if(isTwo) renderTwoSessionsTable(res.weeks);
  else renderSingleGroupTable(group, res.weeks);

  document.getElementById("tableWrap").style.display = "";
  showMsg("تم تحميل الحضور بنجاح.", false);
}

(async function init(){
  let s = requireSession();
  if(!s) return;

  document.getElementById("who").textContent = s.name || "متدرب";
  document.getElementById("meta").textContent = `الرقم: ${s.traineeId} • الشُعب: -`;
  document.getElementById("summary").textContent = "جار التحميل...";

  // ✅ الأهم: نجيب الاسم والشُعب من getProfile
  s = await ensureProfileAndGroups(s);

  const groups = Array.isArray(s.groups) && s.groups.length ? s.groups : (s.group ? [s.group] : []);
  const active = String(s.primaryGroup || s.group || groups[0] || "");

  document.getElementById("who").textContent = s.name || "متدرب";
  document.getElementById("meta").textContent =
    `الرقم: ${s.traineeId} • الشُعب: ${groups.join(" ، ") || "-"}`;

  renderGroupBar(groups, active, async (g)=>{
    s.primaryGroup = String(g);
    s.group = String(g);
    localStorage.setItem("edu_session", JSON.stringify(s));
    renderGroupBar(groups, g, arguments.callee);
    await loadForGroup(s, g);
  });

  await loadForGroup(s, active);
})();
</script>
</body>
</html>
