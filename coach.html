<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة المدرب</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="assets/config.js"></script>
  <script src="assets/app.js"></script>
  <style>
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{padding:14px;border-radius:16px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .kpi .v{font-size:22px;font-weight:800}
    .kpi .l{opacity:.7;margin-top:4px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(1,minmax(0,1fr))}}
    .card2{padding:14px;border-radius:16px;background:#fff;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .card2 .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f2f4f7;font-weight:700;font-size:12px}
    .btns{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:12px;border:0;cursor:pointer;background:#111;color:#fff;font-weight:700}
    .btn.ghost{background:#f2f4f7;color:#111}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:right}
    .muted{opacity:.7}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">لوحة المدرب</div>
      <div class="actions">
        <a class="btn ghost" href="student.html">لوحة المتدرب</a>
      </div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card2" style="margin-top:12px">
      <div class="top">
        <div>
          <div style="font-weight:900;font-size:18px">ترتيب الشعب</div>
          <div class="muted">أفضل حضور • أعلى غياب • أفضل متوسط درجات</div>
        </div>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table class="table" id="rankTbl">
          <thead>
            <tr>
              <th>الشعبة</th>
              <th>حضور %</th>
              <th>غياب %</th>
              <th>استئذان %</th>
              <th>متوسط المجموع</th>
              <th>روابط</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="grid" id="cards"></div>
  </div>

<script>
(async()=>{
  const kpis = document.getElementById("kpis");
  const cards = document.getElementById("cards");
  const tbody = document.querySelector("#rankTbl tbody");

  const res = await fetch(window.API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ action:"coach_overview" })
  }).then(r=>r.json());

  if(!res.ok){
    kpis.innerHTML = `<div class="kpi"><div class="v">خطأ</div><div class="l">${res.message||""}</div></div>`;
    return;
  }

  // KPIs Highlights
  const h = res.highlights || {};
  kpis.innerHTML = `
    <div class="kpi">
      <div class="v">${h.bestAttendance ? (h.bestAttendance.حضورPct + "%") : "-"}</div>
      <div class="l">أفضل حضور (${h.bestAttendance ? h.bestAttendance.group : "—"})</div>
    </div>
    <div class="kpi">
      <div class="v">${h.worstAbsence ? (h.worstAbsence.غيابPct + "%") : "-"}</div>
      <div class="l">أعلى غياب (${h.worstAbsence ? h.worstAbsence.group : "—"})</div>
    </div>
    <div class="kpi">
      <div class="v">${h.bestGrades ? (h.bestGrades.avgTotal) : "-"}</div>
      <div class="l">أفضل متوسط مجموع (${h.bestGrades ? h.bestGrades.group : "—"})</div>
    </div>
    <div class="kpi">
      <div class="v">${res.groups.length}</div>
      <div class="l">عدد الشعب</div>
    </div>
  `;

  // Ranking table
  const sorted = [...res.groups].sort((a,b)=> (b.attendance.حضورPct - a.attendance.حضورPct));
  tbody.innerHTML = sorted.map(g=>{
    const avg = (g.grades && g.grades.avgTotal !== null) ? g.grades.avgTotal : "—";
    return `
      <tr>
        <td><b>${g.group}</b></td>
        <td>${g.attendance.حضورPct}%</td>
        <td>${g.attendance.غيابPct}%</td>
        <td>${g.attendance.استئذانPct}%</td>
        <td>${avg}</td>
        <td>
          <a class="btn ghost" href="attendance.html?group=${encodeURIComponent(g.group)}">الحضور</a>
          <a class="btn ghost" href="grades.html?group=${encodeURIComponent(g.group)}">الدرجات</a>
        </td>
      </tr>
    `;
  }).join("");

  // Cards
  cards.innerHTML = sorted.map(g=>{
    const avg = (g.grades && g.grades.avgTotal !== null) ? g.grades.avgTotal : "—";
    return `
      <div class="card2">
        <div class="top">
          <div style="font-weight:900;font-size:18px">شعبة ${g.group}</div>
          <span class="pill">حضور ${g.attendance.حضورPct}%</span>
        </div>
        <div class="muted" style="margin-top:6px">
          غياب ${g.attendance.غيابPct}% • استئذان ${g.attendance.استئذانPct}% • متوسط ${avg}
        </div>
        <div class="btns">
          <a class="btn" href="attendance.html?group=${encodeURIComponent(g.group)}">عرض الحضور</a>
          <a class="btn ghost" href="grades.html?group=${encodeURIComponent(g.group)}">عرض الدرجات</a>
        </div>
      </div>
    `;
  }).join("");

})();
</script>
</body>
</html>
